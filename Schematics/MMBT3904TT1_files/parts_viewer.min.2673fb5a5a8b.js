(function(){function e(e){var t=Array.prototype.slice.call(arguments);typeof arguments[0]=="function"&&t.shift().apply(this,t)}window.loadFootprint=function(e){$.get(e,function(e){var n=document.getElementById("firstfootprint"),r=n.getContext("2d");window.fp2=new t(r,$(e).find("package").eq(0)),r.clearRect(0,0,500,500),(r.repaint=function(){fp2.draw()})(),r.repaint=function(){fp2.action="drag",fp2.draw()},$(n).scalable(1,1)},"xml")},window.loadSymbol=function(e){$.get(e,function(e){var t=document.getElementById("firstsymbol"),r=t.getContext("2d");window.symbol=new n(r,$(e).find("symbol").eq(0)),r.clearRect(0,0,500,500),(r.repaint=function(){symbol.draw()})(),r.repaint=function(){symbol.action="drag",symbol.draw()},$(t).scalable(1,1,.9);var i=r.canvas.width/symbol.width;i<1&&$(t).scalable(1,1,i)},"xml")},window.loadBoth=function(e){$.get(e,function(e){var r=document.getElementById("firstsymbol").getContext("2d"),i=document.getElementById("firstfootprint").getContext("2d"),s=$(e);window.fp=new t(i,s.find("package").eq(0));var o=s.find("package").eq(0).attr("name");window.symbol=new n(r,s.find("symbol").eq(0),fp),(r.repaint=function(){symbol.draw()})(),$(r.canvas).scalable(1,1,1);var u=r.canvas.width/(symbol.width+120);u<1&&$(r.canvas).scalable(135,110,u),i.repaint=function(){fp.action="drag",fp.draw()},$(i.canvas).scalable(1,1)},"xml")},window.loadSymbolModal=function(e){$.get(e,function(e){var t=document.getElementById("canvassym").getContext("2d"),r=document.getElementById("canvasfp").getContext("2d");$(t.canvas).show(),$(r.canvas).hide(),$("#text").css("display","none"),window.symbol=new n(t,$(e).find("symbol").eq(0)),(t.repaint=function(){symbol.draw()})(),t.repaint=function(){symbol.action="drag",symbol.draw()},$(t.canvas).scalable(1,1,.9);var i=t.canvas.width/symbol.width;i<1&&$(t.canvas).scalable(1,2,i)},"xml")},window.loadFootprintModal=function(e){$.get(e,function(e){var n=document.getElementById("canvassym").getContext("2d"),r=document.getElementById("canvasfp").getContext("2d");$(n.canvas).hide(),$(r.canvas).show(),$("#text").css("display","none"),window.fp=new t(r,$(e).find("package").eq(0)),(r.repaint=function(){fp2.draw()})(),r.repaint=function(){fp.action="drag",fp.draw()},$(r.canvas).scalable(1,1)},"xml")},window.loadBothModal=function(e){$.get(e,function(e){var r=document.getElementById("canvassym").getContext("2d"),i=document.getElementById("canvasfp").getContext("2d");$(r.canvas).show(),$(i.canvas).show(),$("#text").css("display","none");var s=$(e);window.fp=new t(i,s.find("package").eq(0)),window.symbol=new n(r,s.find("symbol").eq(0),fp),(r.repaint=function(){symbol.draw()})(),$(r.canvas).scalable(1,1,.9);var o=r.canvas.width/(symbol.width+120);o<1&&$(r.canvas).scalable(135,110,o),i.repaint=function(){fp.action="drag",fp.draw()},$(i.canvas).scalable(1,1)},"xml")},$.extend(CanvasRenderingContext2D.prototype,{t:{x:0,y:0,s:1},hover:[],checkPoint:function(e,t,n){return e.w&&e.h&&n>e.y&&n<e.y+e.h&&t>e.x&&t<e.x+e.w||e.r&&Math.sqrt((t-e.x)*(t-e.x)+(n-e.y)*(n-e.y))<e.r},arrow:function(e,t,n,r){var i=6,s=Math.atan2(r-t,n-e);this.lineJoin="round",this.moveTo(e,t),this.lineTo(n,r),this.lineTo(n-i*Math.cos(s-Math.PI/6),r-i*Math.sin(s-Math.PI/6)),this.moveTo(n,r),this.lineTo(n-i*Math.cos(s+Math.PI/6),r-i*Math.sin(s+Math.PI/6))},reset:function(){},clean:function(){this.t={x:0,y:0,s:1},this.hover=[],this.canvas.width=this.canvas.width;return},dim:function(e){var e=$.extend({line:20,arrow:25,lineWidth:1.5,side:1,leftArrow:!0,rightArrow:!0,txtPos:"r",space:3,fontSize:10,color:"#D8A3B4",gap:40,symbol:"",dir:"l"},e),t=e.xb-e.xa,n=e.yb-e.ya,r=t/n,i=n/t,s=Math.round(Math.sqrt(Math.pow(t,2)+Math.pow(n,2))*10)/10,o=s>48;o&&(e.arrow=s/2-(n==0?e.gap/2:e.fontSize*.9));if(t<0&&n==0||o){var u=e.xa;e.xa=e.xb,e.xb=u}if(n<0&&t==0||o){var a=e.ya;e.ya=e.yb,e.yb=a}e.rightArrow===!0&&(e.rightArrow=e.arrow),e.leftArrow===!0&&(e.leftArrow=e.arrow),this.beginPath();var f=e.dir=="l"||e.dir=="t"?-1:1;if(t==0)this.moveTo(e.xa+f*e.space,e.ya),this.lineTo(e.xa+f*e.line,e.ya),this.arrow(e.xa+f*(e.line-5),e.ya-e.arrow,e.xa+f*(e.line-5),e.ya-4),this.textAlign="center",this.textBaseline=o?"middle":"bottom",this.font=e.fontSize+"px Arial",this.fillStyle=e.color,this.fillText(s+e.symbol,e.xa+f*(e.line-5),o?e.ya-s/2:e.ya-e.arrow),this.moveTo(e.xb+f*e.space,e.yb),this.lineTo(e.xb+f*e.line,e.yb),this.arrow(e.xb+f*(e.line-5),e.yb+e.arrow,e.xb+f*(e.line-5),e.yb+4),this.lineWidth=e.lineWidth,this.strokeStyle=e.color,this.stroke();else if(n==0){var l=f*(e.line-5);this.moveTo(e.xa,e.ya+f*e.space),this.lineTo(e.xa,e.ya+f*e.line),e.leftArrow&&this.arrow(e.xa-e.leftArrow,e.ya+l,e.xa-4,e.ya+f*(e.line-5)),this.textAlign=o?"center":e.txtPos=="r"?"left":"right",this.textBaseline="middle",this.font=e.fontSize+"px Arial",this.fillStyle=e.color;var c=o?e.xa-s/2:e.txtPos=="r"?e.xb+e.rightArrow+2:e.xa-e.leftArrow-2;this.fillText(s+e.symbol,c,e.ya+l),this.moveTo(e.xb,e.yb+f*e.space),this.lineTo(e.xb,e.yb+f*e.line),this.arrow(e.xb+e.rightArrow,e.yb+l,e.xb+4,e.yb+f*(e.line-5)),this.lineWidth=e.lineWidth,this.strokeStyle=e.color,this.stroke()}this.closePath()},addListeners:function(){var t=this;this.canvas.addEventListener("mousemove",function(n){var r=n.offsetX,i=n.offsetY;t.hover.forEach(function(n){t.checkPoint(n,r,i)?n.over||(n.over=!0,e(n.cb,n)):n.over&&(n.over=!1,e(n.out,n))})}),this.canvas.addEventListener("mouseleave",function(){t.hover.forEach(function(t){t.over&&(t.over=!1,e(t.out,t))})})}}),$(function(){$("canvas").each(function(){this.getContext("2d").addListeners()})}),Element.prototype.attr=function(){var e={};return Array.prototype.slice.call(this.attributes).forEach(function(t){e[t.name]=t.value}),e},$.fn.scalable=function(t,n,r){return this.each(function(){var t=!1,n,i=r||1,s=$(this)[0].getContext("2d"),o=$(this).on({mousedown:function(e){t=e.pageX,n=e.pageY},mousemove:function(e){t!=0&&(o.trigger("scale",{dx:e.pageX-t,dy:e.pageY-n,draging:!0}),t=e.pageX,n=e.pageY)},mouseup:function(e){s.t.dx=(s.t.dx||0)+e.pageX-t,s.t.dy=(s.t
.dy||0)+e.pageY-n,t=!1,n=0},scale:function(t,n){n.scale&&(i=n.scale),i+=n.s||0,s.canvas.width=s.canvas.width,s.t.x=n.x||s.t.x+(n.dx||0),s.t.y=n.y||s.t.y+(n.dy||0),s.t.s=i,s.translate(s.t.x,s.t.y);var r=.2,o=3;i=i<r?r:i>o?o:i,s.scale(i,i),n.draging||s.translate(-s.t.x,-s.t.y),e(s.repaint)}}).css("cursor","crosshair");s.canvas.addEventListener("mousewheel",function(e){e.preventDefault();var t=e.pageX-$(this).offset().left,n=e.pageY-$(this).offset().top;return o.trigger("scale",{s:e.wheelDelta>0?.1:-0.1,x:t,y:n}),!1},!1)})};var t=function(e,t){e.clean(),$.extend(this,{ctx:e,$xml:$(t),onPad:[],offPad:[],action:"init"}),e.lineJoin="round",this.$elements=this.$xml.children(),e.hover=[];var n=this;(e.repaint=function(){n.action="drag",n.draw()})()};$.extend(t.prototype,{draw:function(){var t=this;console.log("---Redraw Footprint"),this.addHovers=["drag","scale","init"].indexOf(t.action)+1,this.smds={all:[],left:[],right:[],top:[],bottom:[]},this.pads={all:[],left:[],right:[],top:[],bottom:[]},this.sides={},X=[],Y=[],this.addHovers&&(t.ctx.hover=[]),this.$elements.each(function(){var n=this.attr();if(n.layer&&t.chipLayerNumbers.indexOf(parseInt(n.layer))<0)return;switch(this.nodeName){case"wire":t.wire(n);if(n.layer==21){var r=t.xValue(n.x1),i=t.yValue(n.y1),s=t.xValue(n.x2),o=t.yValue(n.y2);X.indexOf(r)<0&&Y.indexOf(o)<0&&X.push(r)&Y.push(o),X.indexOf(s)<0&&Y.indexOf(i)<0&&X.push(s)&Y.push(i)}break;case"rectangle":t.rectangle(n);break;case"circle":t.circle(n);break;case"smd":var u=t.smd(this);t.smds.all.push(u);if(t.addHovers){var a=this;t.ctx.hover.push({x:t.ctx.t.x+u.x*t.ctx.t.s,y:t.ctx.t.y+u.y*t.ctx.t.s,w:u.w*t.ctx.t.s,h:u.h*t.ctx.t.s,cb:function(){t.hover!=a&&(t.hover=a,e(t.onPad[n.name]),t.action="hover",t.draw())},out:function(){t.hover=!1,e(t.offPad[n.name]),t.action="out",t.draw()}})}break;case"pad":t.pads.all.push(t.pad(this));break;case"pin":t.pin(n)}}),$.extend(this.sides,{minX:Math.min.apply(null,X),minY:Math.min.apply(null,Y),maxX:Math.max.apply(null,X),maxY:Math.max.apply(null,Y)}),this.sides.centerX=this.sides.minX+(this.sides.maxX-this.sides.minX)/2,this.sides.centerY=this.sides.minY+(this.sides.maxY-this.sides.minY)/2,this.smds.all.forEach(function(e){e.w>e.h?t.smds[e.x<t.sides.centerX?"left":"right"].push(e):t.smds[e.y<t.sides.centerY?"top":"bottom"].push(e)}),this.pads.all.forEach(function(e){var n;e.y<t.sides.maxY&&(n="top"),e.y>t.sides.minY&&(n="bottom"),e.x<t.sides.minX&&(n="left"),e.x>t.sides.maxX&&(n="right"),t.pads[n].push(e)}),t.order(t.pads.top,"x"),t.order(t.smds.top,"x"),t.order(t.pads.bottom,"x"),t.order(t.smds.bottom,"x"),t.order(t.pads.left,"y"),t.order(t.smds.left,"y"),t.order(t.pads.right,"y"),t.order(t.smds.right,"y"),this.action="redraw"},order:function(e,t){e.sort(function(e,n){return e[t]<n[t]?-1:e[t]>n[t]?1:0})},symbolLayerNumbers:[],lineWidth:13,scaleFactor:25,defaultLineWidth:1,defaultCurveRadius:1*this.scaleFactor,layerNumberForPads:17,layerNumberForPins:94,longSquareSideLength:1.27*this.scaleFactor,longCircleRadius:.6*this.scaleFactor,pinLength:2.5*this.scaleFactor,pinNameDistance:5*this.scaleFactor,fontHeight:10,chipLayerNumbers:[21,17,1],wireColor:"white",xValue:function(e){var t=this.ctx.canvas.width/2,n=this.scaleValue(e),r=n+t;return r},yValue:function(e){var t=this.ctx.canvas.height/2,n=this.scaleValue(e),r=-n,i=r+t;return i},mark:function(e,t,n){this.ctx.beginPath(),this.ctx.arc(e,t,5,5,360),this.ctx.fillStyle=n||"red",this.ctx.fill(),this.ctx.stroke()},showDimensions:function(){var e=this.smds.left,t=this.smds.right,n=this.smds.top,r=this.smds.bottom;lp=this.pads.left,rp=this.pads.right,tp=this.pads.top,bp=this.pads.bottom;if(e.length)this.ctx.dim({xa:e[0].x,ya:e[0].y,xb:e[0].x+e[0].w,yb:e[0].y,line:45,txtPos:"l",rightArrow:15,leftArrow:15,dir:"t"}),e[1]&&this.ctx.dim({xa:e[0].x,ya:e[0].y+e[1].h/2,xb:e[1].x,yb:e[1].y+e[1].h/2,arrow:15}),e[3]?this.ctx.dim({xa:e[e.length-1].x,ya:e[e.length-1].y,xb:e[e.length-1].x,yb:e[e.length-1].y+e[e.length-1].h,arrow:15}):this.ctx.dim({xa:t[0].x+t[0].w,ya:t[0].y,xb:t[0].x+t[0].w,yb:t[0].y+t[0].h,dir:"r",arrow:15});else if(lp.length){var i=lp[0].r;this.ctx.dim({xa:lp[0].x-i,ya:lp[0].y,xb:lp[0].x+i,yb:lp[0].y,line:40,txtPos:"l",rightArrow:15,leftArrow:15,dir:"t"}),lp.length>1&&this.ctx.dim({xa:lp[lp.length-2].x-i,ya:lp[lp.length-2].y,xb:lp[lp.length-1].x-i,yb:lp[lp.length-1].y})}else this.pads.top.length&&this.pads.bottom.length?this.ctx.dim({xa:this.pads.top[0].x,ya:this.pads.top[0].y-this.pads.top[0].r,xb:this.pads.top[0].x,yb:this.pads.bottom[0].y+this.pads.bottom[0].r,line:60}):this.smds.top.length&&this.smds.bottom.length&&this.ctx.dim({xa:this.smds.bottom[0].x,ya:this.smds.top[this.smds.top.length-1].y,xb:this.smds.bottom[0].x,yb:this.smds.bottom[0].y+this.smds.bottom[0].h,line:40});if(tp.length){var i=tp[0].r;this.ctx.dim({xa:tp[0].x-i,ya:tp[0].y,xb:tp[0].x+i,yb:tp[0].y,line:40,txtPos:"l",rightArrow:15,leftArrow:15,dir:"t"}),tp.length>1&&this.ctx.dim({xa:tp[tp.length-2].x,ya:tp[tp.length-2].y,xb:tp[tp.length-1].x,yb:tp[tp.length-1].y,line:40})}this.ctx.dim({xa:this.sides.maxX,ya:this.sides.minY,xb:this.sides.maxX,yb:this.sides.maxY,dir:"r",line:90});var s=0;this.smds.bottom.length&&(s=this.smds.bottom[0].h),this.pads.bottom.length&&(s=this.pads.bottom[0].r*2),this.ctx.dim({xa:this.sides.minX,ya:this.sides.maxY,xb:this.sides.maxX,yb:this.sides.maxY,line:20+s,dir:"b"});if(e.length&&t.length){var o=e[e.length-1].y+e[e.length-1].h;this.ctx.dim({xa:e[e.length-1].x,xb:t[t.length-1].x+t[t.length-1].w,ya:o,yb:o,line:60+s,dir:"b"})}else if(lp.length&&rp.length){var i=lp[0].r,o=lp[lp.length-1].y+s;this.ctx.dim({xa:lp[lp.length-1].x-i,xb:rp[rp.length-1].x+i,ya:o,yb:o,line:65+s,dir:"b"})}if(!e.length&&n.length){this.ctx.dim({xa:n[n.length-1].x+n[n.length-1].w,ya:n[n.length-1].y,xb:n[n.length-1].x+n[n.length-1].w,yb:n[n.length-1].y+n[n.length-1].h,line:30,dir:"r"}),this.ctx.dim({ya:n[0].y,xa:n[0].x+n[1].w/2,yb:n[1].y,xb:n[1].x+n[1].w/2,arrow:15,txtPos:"l",rightArrow:15,leftArrow:15});if(n[1]){var u=n[n.length-1];this.ctx
.dim({xa:u.x,ya:u.y,xb:u.x+u.w,yb:u.y,arrow:15})}}},rotationValue:function(e){if(!e)return;var t,n=e.charAt(0);return n=="0"?e=0:(t=e.slice(1),n=="R"?e=t:e=-t),e=e*Math.PI/180,e},scaleValue:function(e){return parseFloat(e)*this.scaleFactor},text:function(e,t,n,r){this.ctx.beginPath(),this.ctx.textAlign=r,this.ctx.font=this.fontHeight+"px Arial",this.ctx.fillText(e,t,n)},wire:function(e){var t=this.xValue(e.x1),n=this.yValue(e.y1),r=this.xValue(e.x2),i=this.yValue(e.y2),s=this.scaleValue(e.width)-2;if(e.curve){var o=parseFloat(e.curve);this.curvedLine(t,n,r,i,s,o)}else this.line(t,n,r,i,s)},rectangle:function(e){var t=this.xValue(e.x1),n=this.yValue(e.y1),r=this.xValue(e.x2),i=this.yValue(e.y2);this.line(t,n,r,n,this.defaultLineWidth),this.line(r,n,r,i,this.defaultLineWidth),this.line(r,i,t,i,this.defaultLineWidth),this.line(t,i,t,n,this.defaultLineWidth),this.ctx.closePath(),this.ctx.fillStyle="#FF00FF",this.ctx.fill()},line:function(e,t,n,r,i){this.ctx.beginPath(),this.ctx.moveTo(e,t),this.ctx.lineTo(n,r),this.ctx.lineWidth=i,this.ctx.strokeStyle=this.wireColor,this.ctx.stroke()},curvedLine:function(e,t,n,r,i,s){var o=(n+e)/2,u=(r+t)/2;isCounter=!1;if(e==n){var a=.5*Math.PI,f=1.5*Math.PI;isCounter=!0}else if(t==r)var a=0*Math.PI,f=1*Math.PI;this.ctx.beginPath(),this.ctx.arc(o,u,this.defaultCurveRadius,a,f,isCounter),this.ctx.lineWidth=i,this.ctx.stroke()},circle:function(e){var t=this.xValue(e.x),n=this.yValue(e.y),r=this.scaleValue(e.width),i=this.scaleValue(e.radius);this.ctx.beginPath(),this.ctx.arc(t,n,i,0,2*Math.PI,!1),this.ctx.lineWidth=r,this.ctx.stroke()},smd:function(e){var t=e.attr(),n="",r=this.xValue(t.x),i=this.yValue(t.y),s=this.scaleValue(t.dx),o=this.scaleValue(t.dy);this.ctx.fillStyle=this.hover==e?"blue":"#FF761A";if(t.rot=="R90"||t.rot=="R270"){var u=r-o/2,a=i-s/2,f=o,l=s;n=t.y>0?"t":"b"}else{var u=r-s/2,a=i-o/2,f=s,l=o;n=t.x>0?"r":"l"}return this.ctx.fillRect(u,a,f,l),{x:u,y:a,w:f,h:l,dir:n}},pin:function(e){var t=this.ctx,n=this.xValue(e.x),r=this.yValue(e.y),i,s=n+this.pinLength,o=e.name,u,a,f,l,c,h,p;e.rot?(i=this.rotationValue(e.rot),t.save(),t.translate(n,r),t.rotate(i),this.line(0,0,this.pinLength,0,this.defaultLineWidth),t.restore(),f=n-this.pinNameDistance,l=r+this.fontHeight/2,o.charAt(0)=="!"?(p=o.slice(1),this.text(p,f,l,"right"),a=t.measureText(p),u=a.width,c=f-u,h=l-this.fontHeight,this.line(c,h,c+u,h,this.defaultLineWidth)):this.text(o,f,l,"right")):(f=n+this.pinNameDistance,l=r+this.fontHeight/2,this.line(n,r,s,r,this.defaultLineWidth),o.charAt(0)=="!"?(p=o.slice(1),this.text(p,f,l,"left"),a=t.measureText(p),u=a.width,c=f,h=l-this.fontHeight,this.line(c,h,c+u,h,this.defaultLineWidth)):this.text(o,f,l,"left"))},pad:function(t){var n=this,r=t.attr(),i=this.xValue(r.x),s=this.yValue(r.y),o=this.scaleValue(r.drill)/2,u,a;return a=this.rotationValue(r.rot),u=o*2,this.outerCircle(i,s,u,this.hover==t?"blue":null),this.innerCircle(i,s,o),this.addHovers&&n.ctx.hover.push({x:this.ctx.t.x+i*this.ctx.t.s,y:this.ctx.t.y+s*this.ctx.t.s,r:u*this.ctx.t.s,cb:function(){n.hover!=t&&(n.hover=t,e(n.onPad[t.attr().name]),n.action="hover",n.draw())},out:function(){n.hover=!1,e(n.offPad[t.attr().name]),n.action="out",n.draw()}}),{x:i,y:s,r:u}},outerCircle:function(e,t,n,r){this.ctx.beginPath(),this.ctx.arc(e,t,n,0,2*Math.PI,!1),this.ctx.strokeStyle="transparent",this.ctx.fillStyle=r||"#FF761A",this.ctx.fill(),this.ctx.lineWidth=this.defaultLineWidth,this.ctx.stroke()},innerCircle:function(e,t,n){this.ctx.beginPath(),this.ctx.arc(e,t,n,0,2*Math.PI,!1),this.ctx.fillStyle="#C1C1F5",this.ctx.fill(),this.ctx.lineWidth=this.defaultLineWidth,this.ctx.stroke()},drawLong:function(e,t,n,r){var i=this.ctx,s=e-this.longSquareSideLength/2,o=t-this.longSquareSideLength/2;i.beginPath(),i.rect(s,o,this.longSquareSideLength,this.longSquareSideLength),i.fillStyle="green",i.fill(),i.stroke(),i.strokeStyle="green",i.save(),i.translate(e,t),i.rotate(r);var u=-this.longSquareSideLength/2,a=0;i.beginPath(),i.arc(u,a,this.longCircleRadius,0,2*Math.PI,!1),i.fillStyle="green",i.strokeStyle="green",i.fill(),i.stroke();var f=this.longSquareSideLength/2,l=0;i.beginPath(),i.arc(f,l,this.longCircleRadius,0,2*Math.PI,!1),i.fillStyle="green",i.strokeStyle="green",i.fill(),i.stroke(),i.restore(),this.innerCircle(e,t,n)}});var n=function(e,t,n){e.clean();if(!t[0])return!1;$.extend(this,{ctx:e,$xml:$(t),connects:[]}),this.$wires=this.$xml.children("wire"),this.$pins=this.$xml.children("pin"),this.$texts=this.$xml.children("text"),this.$rectangles=this.$xml.children("rectangle"),this.$circles=this.$xml.children("circle");if(n){var r=this;n!==!0&&(r.footprint=n,$(t[0].ownerDocument).find("connects").eq(0).children("connect").each(function(){var e=this.attr();r.connects.push({attr:e,pin:r.$xml.children('pin[name="'+e.pin+'"]').eq(0)[0],pad:r.footprint.$xml.children('smd[name="'+e.pad+'"],pad[name="'+e.pad+'"]').eq(0)[0]})})),(e.repaint=function(){r.draw()})(),r.scale()}};$.extend(n.prototype,{draw:function(){var e=this,t=10;this.sides={};var n=[],r=[];console.log("---Redraw Symbol");if(!this.ctx)return;e.ctx.hover=[];var i=this.ctx.canvas.width/2,s=this.ctx.canvas.height/2,o,u,a,f;this.$wires.each(function(){var o=$(this);x1=parseFloat(o.attr("x1")*t+i),x2=parseFloat(o.attr("x2")*t+i),y1=parseFloat(-o.attr("y1")*t+s),y2=parseFloat(-o.attr("y2")*t+s);var u=97;o.attr("layer")==u&&(x1+=32,x2+=28),e.drawLine(x1,y1,x2,y2,o.attr("width")),n.indexOf(x1)<0&&r.indexOf(y2)<0&&n.push(x1)&r.push(y2),n.indexOf(x2)<0&&r.indexOf(y1)<0&&n.push(x2)&r.push(y1)}),this.$rectangles.each(function(){var n=$(this);x1=parseFloat(n.attr("x1")*t+i),x2=parseFloat(n.attr("x2")*t+i),y1=parseFloat(-n.attr("y1")*t+s),y2=parseFloat(-n.attr("y2")*t+s),rot=e._rotationValue(n.attr("rot")),e._drawRectangle(x1,y1,x2,y2,rot)}),this.$circles.each(function(){var n=$(this);x=parseFloat(n.attr("x")*t+i),y=parseFloat(-n.attr("y")*t+s),radius=parseFloat(n.attr("radius")*t),width=parseFloat(n.attr("width")*t),e._drawCircle(x,y,radius,width)});var o=Math.min.apply
(null,n),f=Math.min.apply(null,r),u=Math.max.apply(null,n),a=Math.max.apply(null,r);this.width=u-o,this.height=a-f,this.$pins.each(function(){var o=this.attr(),u=o.x,l=o.y,c=o.length,h=u*t+i,p=-l*t+s;length=c=="short"?2.54:c=="middle"?5.08:c=="point"?0:7.62,length*=t;if(o.rot=="R90"||o.rot=="R270"){var d=u*t+i,v=v+length;g=p>v?"t":"b",e.drawLine(h,p,d,v),o.visible!="off"&&o.visible!="pad"&&e.drawTextRotate(o.name,u*t+i,o.y<0?a-t:f+t,l<0?"left":"right")}else{var d=h+length,m=15;o.rot=="R180"&&(d=h-length,m=-m);var v=-l*t+s,g=h>d?"r":"l";e.drawLine(h,p,d,v),o.visible!="off"&&o.visible!="pad"&&e.drawText(o.name,d+m,-l*t+s,o.rot!="R180"?"left":"right")}o["function"]&&e.drawPinFunction(d,v,g,o["function"]),$(this).attr({ctx_x:h,ctx_y:p,ctx_dir:g}),n.indexOf(h)<0&&r.indexOf(v)<0&&n.push(h)&r.push(v),n.indexOf(d)<0&&r.indexOf(p)<0&&n.push(d)&r.push(p)}),this.$texts.each(function(){var n=$(this),r=n.text();r.indexOf("NAME")==-1&&r.indexOf("VALUE")==-1&&e.drawText(r,parseFloat(n.attr("x"))*t+i,-parseFloat(n.attr("y"))*t+s,"left",n.attr("size"))}),this.action="redraw",this.footprint?this.connects.forEach(function(t){e.footprint.onPad[t.attr.pad]=function(){e.connection(t.pin,t.pad,"blue",1)},e.footprint.offPad[t.attr.pad]=function(){e.connection(t.pin,t.pad,null,1)},t.pin&&e.connection(t.pin,t.pad)}):this.$pins.each(function(){e.connection(this)}),$.extend(this.sides,{minX:Math.min.apply(null,n)-25,minY:Math.min.apply(null,r)-25,maxX:Math.max.apply(null,n)+25,maxY:Math.max.apply(null,r)+25}),this.sides.width=this.sides.maxX-this.sides.minX,this.sides.height=this.sides.maxY-this.sides.minY,this.sides.centerX=this.sides.minX+(this.sides.maxX-this.sides.minX)/2,this.sides.centerY=this.sides.minY+(this.sides.maxY-this.sides.minY)/2},mark:function(e,t,n){this.ctx.beginPath(),this.ctx.arc(e,t,5,5,360),this.ctx.fillStyle=n||"red",this.ctx.fill(),this.ctx.stroke()},scale:function(){var e=this.ctx.canvas.width/this.sides.width,t=this.ctx.canvas.height/this.sides.height,n=e<t?e:t;n<1&&$(this.ctx.canvas).trigger("scale",{x:-this.sides.minX*n,y:-this.sides.minY*n,scale:n})},connection:function(e,t,n,r){if(!e)return;var i=this,s=12,o=e.attr();i.ctx.fillStyle=n||"#FF761A"||"rgba(200, 180, 80, 0.8)";var u=o.ctx_dir=="l"||o.ctx_dir=="r",a={x:o.ctx_x-(u?o.ctx_dir=="r"?s-1:1:s/2),y:o.ctx_y-(u?s/2:o.ctx_dir=="t"?s-1:1),w:s,h:s};i.ctx.fillRect(a.x,a.y,a.w,a.h);var f=20;u?i.ctx.fillRect(o.ctx_x,o.ctx_y-i.lineWidth*this.dw/2,f*(o.ctx_dir=="l"?-1:1),i.lineWidth*this.dw):i.ctx.fillRect(o.ctx_x-i.lineWidth*this.dw/2,o.ctx_y,i.lineWidth*this.dw,f*(o.ctx_dir=="b"?-1:1)),a={x:i.ctx.t.x+a.x*i.ctx.t.s,y:i.ctx.t.y+a.y*i.ctx.t.s,w:s*i.ctx.t.s,h:s*i.ctx.t.s},!r&&t&&i.ctx.hover.push($.extend(a,{cb:function(){i.connection(e,t,"blue",1),i.footprint.hover=t,i.footprint.draw()},out:function(){i.connection(e,t,null,1),i.footprint.hover=!1,i.footprint.draw()}}))},lineWidth:8,dw:.5,df:1,pinSize:10,_drawRectangle:function(e,t,n,r,i,s){var o=Math.abs(n-e),u=Math.abs(r-t),a={x:e+o*.5,y:t-u*.5};this.ctx.save(),this.ctx.translate(a.x,a.y),e=-(o*.5),t=-(u*.5),this.ctx.rotate(Math.PI/180*i),this.ctx.lineWidth=this.lineWidth*(parseFloat(s)||this.dw),this.ctx.fillRect(e,t,o,u),this.ctx.translate(-a.x,-a.y),this.ctx.restore()},drawLine:function(e,t,n,r,i){this.ctx.beginPath(),this.ctx.moveTo(e,t),this.ctx.lineTo(n,r),this.ctx.lineWidth=this.lineWidth*(parseFloat(i)||this.dw),this.ctx.stroke()},drawPinFunction:function(e,t,n,r){switch(r){case"dot":this.dot(e,t,n);break;case"clk":this.clk(e,t,n);break;case"dotclk":this.dotclk(e,t,n)}},dot:function(e,t,n){n=="l"&&(e-=this.pinSize),n=="r"&&(e+=this.pinSize),n=="t"&&(t-=this.pinSize),n=="b"&&(t+=this.pinSize),this._drawCircle(e,t,this.pinSize,this.lineWidth*.5)},clk:function(e,t,n){this._drawTriangle(e,t,n,this.pinSize)},dotclk:function(e,t,n){this.dot(e,t,n),n=="l"&&(e+=this.pinSize),n=="r"&&(e-=this.pinSize),n=="t"&&(t+=this.pinSize),n=="b"&&(t-=this.pinSize),this._drawTriangle(e,t,n,this.pinSize)},_drawCircle:function(e,t,n,r){this.ctx.save(),this.ctx.beginPath(),this.ctx.lineWidth=r?r:this.lineWidth,this.ctx.arc(e,t,n-r,0,2*Math.PI),this.ctx.fillStyle="white",this.ctx.fill(),this.ctx.stroke(),this.ctx.closePath(),this.ctx.restore()},_rotationValue:function(e){if(!e)return;var t,n=e.charAt(0);return n=="0"?e=0:(t=e.replace(/\D/g,""),containsR=e.indexOf("R")>-1?!0:!1,e=containsR?-t:t),e},_drawTriangle:function(e,t,n,r){var i=n=="l"?180:n=="b"?270:n=="t"?90:0;this.ctx.save(),this.ctx.translate(e,t),this.ctx.rotate(Math.PI/180*i),this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.lineTo(r,r),this.ctx.lineTo(r,-r),this.ctx.closePath(),this.ctx.fill(),this.ctx.translate(-e,-t),this.ctx.restore()},drawCircle:function(e,t,n){this.ctx.beginPath(),this.ctx.arc(e,t,10,0,2*Math.PI),this.ctx.lineWidth=this.lineWidth*(n||this.dw),this.ctx.stroke()},drawText:function(e,t,n,r,i){this.ctx.beginPath(),this.ctx.textAlign=r,this.ctx.textBaseline="middle",this.ctx.font=16*(i||this.df)+"px Arial",this.ctx.fillStyle="black";var s=e.split("").join(String.fromCharCode(8202));this.ctx.fillText(s,t,n)},drawTextRotate:function(e,t,n,r){this.ctx.save(),this.ctx.translate(t,n),this.ctx.textAlign=r,this.ctx.font="16px Arial bold",this.ctx.rotate(-1*Math.PI/2),this.ctx.fillText(e,0,0),this.ctx.restore()}})}).call(this);
